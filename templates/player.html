{% extends "player_base.html" %}

{% block title %}{{ player_code }} | Slippi Stats{% endblock %}

{% block additional_styles %}
.stat-card {
    border-radius: 10px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    transition: transform 0.2s;
}
.stat-card:hover {
    transform: translateY(-5px);
}
.win-rate-circle {
    width: 120px;
    height: 120px;
    border-radius: 50%;
    background: conic-gradient(#198754 0% calc(var(--win-rate) * 100%), #dee2e6 calc(var(--win-rate) * 100%) 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto;
    position: relative;
}
.win-rate-inner {
    width: 100px;
    height: 100px;
    border-radius: 50%;
    background: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    font-weight: bold;
}
.character-badge {
    text-align: center;
    margin-bottom: 15px;
}
.matchup-bar {
    height: 24px;
    border-radius: 4px;
    margin-bottom: 8px;
}
.error-message {
    text-align: center;
    padding: 2rem;
    color: #dc3545;
}
.no-data-message {
    text-align: center;
    padding: 2rem;
    color: #6c757d;
}

/* Character icons */
.character-icon {
    margin-right: 8px;
    vertical-align: middle;
}

.character-icon-fallback {
    display: inline-block;
    width: 24px;
    height: 24px;
    background-color: #f8f9fa;
    border-radius: 50%;
    margin-right: 8px;
    vertical-align: middle;
    text-align: center;
    line-height: 24px;
    font-size: 10px;
    font-weight: bold;
    color: #495057;
}

.character-badge .character-icon {
    width: 64px;
    height: 64px;
}

.character-badge .character-icon-fallback {
    width: 64px;
    height: 64px;
    line-height: 64px;
    font-size: 24px;
    margin: 0 auto 10px auto;
    display: block;
}

.character-container {
    display: inline-flex;
    align-items: center;
}

/* Character-specific fallback colors */
.character-icon-fallback[data-character="fox"] {
    background-color: #fd7e14;
    color: white;
}

.character-icon-fallback[data-character="falco"] {
    background-color: #0d6efd;
    color: white;
}

.character-icon-fallback[data-character="marth"] {
    background-color: #0dcaf0;
    color: white;
}

.character-icon-fallback[data-character="captain_falcon"] {
    background-color: #dc3545;
    color: white;
}

.character-icon-fallback[data-character="jigglypuff"] {
    background-color: #d63384;
    color: white;
}

.character-icon-fallback[data-character="peach"] {
    background-color: #ffc107;
}

.character-icon-fallback[data-character="sheik"] {
    background-color: #6f42c1;
    color: white;
}

.character-icon-fallback[data-character="ice_climbers"] {
    background-color: #6c757d;
    color: white;
}

.dropdown-item.active {
    background-color: #0d6efd;
    color: white;
}
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12">
        <h1 class="display-4">{{ player_code }}</h1>
        <p class="lead">Player Statistics</p>
        <a href="/player/{{ player_code|urlencode }}/detailed" class="btn btn-primary mt-3">Detailed View Here</a>
    </div>
</div>

{% if stats and stats.total_games > 0 %}
<div class="row mb-4">
    <!-- Overall Stats Card -->
    <div class="col-md-4 mb-4">
        <div class="card stat-card h-100">
            <div class="card-body text-center">
                <h5 class="card-title">Overall Performance</h5>
                <div class="win-rate-circle my-3" style="--win-rate: {{ stats.win_rate }}">
                    <div class="win-rate-inner">{{ (stats.win_rate * 100) | round(1) }}%</div>
                </div>
                <p class="card-text">
                    <strong>{{ stats.wins }}</strong> wins out of <strong>{{ stats.total_games }}</strong> games
                </p>
            </div>
        </div>
    </div>

    <!-- Most Played Character Card -->
    {% if stats.most_played_character %}
    <div class="col-md-4 mb-4">
        <div class="card stat-card h-100">
            <div class="card-body text-center">
                <h5 class="card-title">Most Played Character</h5>
                <div class="character-badge">
                    <span data-character-name="{{ stats.most_played_character }}" class="character-container"></span>
                    <h3>{{ stats.most_played_character }}</h3>
                </div>
                <p class="card-text">
                    <strong>{{ stats.character_stats[stats.most_played_character].games }}</strong> games
                    <br>
                    <strong>{{ (stats.character_stats[stats.most_played_character].win_rate * 100) | round(1) }}%</strong> win rate
                </p>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Best Character Card -->
    {% if stats.best_character %}
    <div class="col-md-4 mb-4">
        <div class="card stat-card h-100">
            <div class="card-body text-center">
                <h5 class="card-title">Best Character</h5>
                <div class="character-badge">
                    <span data-character-name="{{ stats.best_character }}" class="character-container"></span>
                    <h3>{{ stats.best_character }}</h3>
                </div>
                <p class="card-text">
                    <strong>{{ stats.character_stats[stats.best_character].games }}</strong> games
                    <br>
                    <strong>{{ (stats.character_stats[stats.best_character].win_rate * 100) | round(1) }}%</strong> win rate
                </p>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<div class="row mb-4">
    <!-- Rising Star Card -->
    {% if stats.rising_star %}
    <div class="col-md-4 mb-4">
        <div class="card stat-card h-100 text-white bg-primary">
            <div class="card-body text-center">
                <h5 class="card-title">On The Rise</h5>
                <div class="character-badge">
                    <span data-character-name="{{ stats.rising_star }}" class="character-container"></span>
                    <h3>{{ stats.rising_star }}</h3>
                </div>
                <p class="card-text">
                    Best recent performance
                    <br>
                    <small>Based on last 30 games</small>
                </p>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Rival Card -->
    {% if stats.rival %}
    <div class="col-md-4 mb-4">
        <div class="card stat-card h-100 text-white bg-danger">
            <div class="card-body text-center">
                <h5 class="card-title">Rival</h5>
                <div class="d-flex justify-content-center align-items-center my-3">
                    <strong class="me-2">{{ stats.rival.opponent_tag }}</strong>
                    playing
                    <span data-character-name="{{ stats.rival.opponent_char }}" class="character-container ms-2"></span>
                </div>
                <h3>{{ stats.rival.opponent_tag }}</h3>
                <p class="card-text">
                    <strong>{{ stats.rival.win_rate * 100 | round(1) }}%</strong> win rate against them
                    <br>
                    <small>{{ stats.rival.wins }} wins out of {{ stats.rival.games }} games</small>
                </p>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Worst Character Card -->
    {% if stats.worst_character %}
    <div class="col-md-4 mb-4">
        <div class="card stat-card h-100 text-white bg-dark">
            <div class="card-body text-center">
                <h5 class="card-title">Toxic Relationship</h5>
                <div class="character-badge">
                    <span data-character-name="{{ stats.worst_character }}" class="character-container"></span>
                    <h3>{{ stats.worst_character }}</h3>
                </div>
                <p class="card-text">
                    <strong>{{ stats.character_stats[stats.worst_character].games }}</strong> games
                    <br>
                    <strong>{{ (stats.character_stats[stats.worst_character].win_rate * 100) |round(1) }}%</strong> win rate
                </p>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<div class="row mb-4">
    <!-- Character Stats -->
    {% if stats.character_stats and stats.character_stats|length > 0 %}
    <div class="col-md-6 mb-4">
        <div class="card stat-card">
            <div class="card-header">
                <h5>Character Stats</h5>
            </div>
            <div class="card-body">
                <div class="chart-container" style="position: relative; height:400px;">
                    <canvas id="characterStatsChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Stage Stats -->
    {% if stats.stage_stats and stats.stage_stats|length > 0 %}
    <div class="col-md-6 mb-4">
        <div class="card stat-card">
            <div class="card-header">
                <h5>Stage Performance</h5>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        {% if stats.best_stage %}
                        <div class="card bg-success text-white mb-3">
                            <div class="card-body">
                                <h6 class="card-title">Best Stage</h6>
                                <p class="card-text">
                                    Stage ID: {{ stats.best_stage.id }}<br>
                                    Win Rate: {{ (stats.best_stage.win_rate * 100) | round(1) }}%<br>
                                    Games: {{ stats.best_stage.games }}
                                </p>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    <div class="col-md-6">
                        {% if stats.worst_stage %}
                        <div class="card bg-danger text-white">
                            <div class="card-body">
                                <h6 class="card-title">Worst Stage</h6>
                                <p class="card-text">
                                    Stage ID: {{ stats.worst_stage.id }}<br>
                                    Win Rate: {{ (stats.worst_stage.win_rate * 100) | round(1) }}%<br>
                                    Games: {{ stats.worst_stage.games }}
                                </p>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
                <div class="chart-container" style="position: relative; height:300px;">
                    <canvas id="stageStatsChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Recent Games -->
<div class="row">
    <div class="col-md-12 mb-4">
        <div class="card stat-card">
            <div class="card-header">
                <h5>Recent Games</h5>
            </div>
            <div class="card-body">
                {% if recent_games and recent_games|length > 0 %}
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Character</th>
                                <th>Opponent</th>
                                <th>Opponent's Character</th>
                                <th>Result</th>
                            </tr>
                        </thead>
                        <tbody id="recentGamesTable">
                            {% for game in recent_games %}
                            <tr>
                                <td>{{ game.start_time }}</td>
                                <td>
                                    <span data-character-name="{{ game.player.character_name }}" class="character-container"></span>
                                    {{ game.player.character_name }}
                                </td>
                                <td>
                                    {% set opponent_tag_encoded = game.opponent.player_tag | urlencode %}
                                    <a href="/player/{{ opponent_tag_encoded }}">
                                        {{ game.opponent.player_name }}
                                    </a>
                                </td>
                                <td>
                                    <span data-character-name="{{ game.opponent.character_name }}" class="character-container"></span>
                                    {{ game.opponent.character_name }}
                                </td>
                                <td>
                                    {% if game.result == 'Win' %}
                                    <span class="badge bg-success">Win</span>
                                    {% else %}
                                    <span class="badge bg-danger">Loss</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div class="d-flex justify-content-center mt-3">
                    <button id="loadMoreGames" class="btn btn-primary">Load More Games</button>
                </div>
                {% else %}
                <div class="no-data-message">
                    <p>No recent games found for this player.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% else %}
<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-body">
                <div class="no-data-message">
                    <h3>No statistics available</h3>
                    <p>This player has no recorded games yet or not enough data to generate statistics.</p>
                    <a href="/" class="btn btn-primary mt-3">Return to Home</a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
{{ super() }}
{% if stats and stats.character_stats and stats.character_stats|length > 0 %}
<script>
    // Character Stats Chart
    const charCtx = document.getElementById('characterStatsChart').getContext('2d');
    const characterData = {
        labels: [
            {% for char, data in stats.character_stats.items() %}
            '{{ char }}',
            {% endfor %}
        ],
        datasets: [
            {
                label: 'Games',
                data: [
                    {% for char, data in stats.character_stats.items() %}
                    {{ data.games }},
                    {% endfor %}
                ],
                backgroundColor: 'rgba(54, 162, 235, 0.5)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 1
            },
            {
                label: 'Win Rate (%)',
                data: [
                    {% for char, data in stats.character_stats.items() %}
                    {{ data.win_rate * 100 }},
                    {% endfor %}
                ],
                backgroundColor: 'rgba(255, 99, 132, 0.5)',
                borderColor: 'rgba(255, 99, 132, 1)',
                borderWidth: 1,
                yAxisID: 'y1'
            }
        ]
    };
    
    new Chart(charCtx, {
        type: 'bar',
        data: characterData,
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Games Played'
                    }
                },
                y1: {
                    beginAtZero: true,
                    position: 'right',
                    title: {
                        display: true,
                        text: 'Win Rate (%)'
                    },
                    max: 100,
                    grid: {
                        drawOnChartArea: false
                    }
                }
            }
        }
    });
</script>
{% endif %}

{% if stats and stats.stage_stats and stats.stage_stats|length > 0 %}
<script>
    // Stage Stats Chart
    const stageCtx = document.getElementById('stageStatsChart').getContext('2d');
    const stageData = {
        labels: [
            {% for stage_id, data in stats.stage_stats.items() %}
            'Stage {{ stage_id }}',
            {% endfor %}
        ],
        datasets: [{
            label: 'Win Rate (%)',
            data: [
                {% for stage_id, data in stats.stage_stats.items() %}
                {{ data.win_rate * 100 }},
                {% endfor %}
            ],
            backgroundColor: [
                {% for stage_id, data in stats.stage_stats.items() %}
                `rgba(${Math.min(255, 255 * (1 - data.win_rate * 2 + 1))}, ${Math.min(255, 255 * data.win_rate * 2)}, 0, 0.7)`,
                {% endfor %}
            ],
            borderWidth: 1
        }]
    };
    
    new Chart(stageCtx, {
        type: 'bar',
        data: stageData,
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100,
                    title: {
                        display: true,
                        text: 'Win Rate (%)'
                    }
                }
            }
        }
    });
</script>
{% endif %}

<script>
// Update the character icon handling function to avoid duplicates
function initializeCharacterIcons(container = document) {
    // Define the character mapping based on the config
    const characterMapping = {
        "Mario": "Mario",
        "Fox": "Fox",
        "Captain Falcon": "Captain Falcon",
        "Donkey Kong": "Donkey Kong",
        "Kirby": "Kirby",
        "Bowser": "Bowser",
        "Link": "Link",
        "Sheik": "Sheik", 
        "Ness": "Ness",
        "Peach": "Peach",
        "Ice Climbers": "Ice Climbers",
        "Yoshi": "Yoshi",
        "Pikachu": "Pikachu",
        "Samus": "Samus",
        "Jigglypuff": "Jigglypuff",
        "Mewtwo": "Mewtwo",
        "Luigi": "Luigi",
        "Marth": "Marth",
        "Zelda": "Zelda",
        "Young Link": "Young Link",
        "Doctor Mario": "Doctor Mario",
        "Dr. Mario": "Doctor Mario",
        "Falco": "Falco",
        "Pichu": "Pichu",
        "Game & Watch": "Game & Watch",
        "Mr. Game & Watch": "Game & Watch",
        "Ganondorf": "Ganondorf",
        "Roy": "Roy"
    };

    // Only select elements that haven't been processed yet
    container.querySelectorAll('[data-character-name]:not([data-icon-processed])').forEach(function(element) {
        // Mark as processed to avoid duplicate icons
        element.setAttribute('data-icon-processed', 'true');
        
        const characterName = element.getAttribute('data-character-name');
        if (characterName && characterMapping[characterName]) {
            // Create the image element
            const img = document.createElement('img');
            img.src = `/static/icons/character/neutral ${characterMapping[characterName]}.png`;
            img.alt = characterName;
            
            // If this is inside a character-badge, make it bigger
            if (element.closest('.character-badge')) {
                img.width = 64;
                img.height = 64;
            } else {
                img.width = 24;
                img.height = 24;
            }
            
            img.className = 'character-icon';
            
            // Add error handling
            img.onerror = function() {
                // If image fails to load, replace with character initial
                this.style.display = 'none';
                const span = document.createElement('span');
                span.className = 'character-icon-fallback';
                span.textContent = characterName.charAt(0);
                
                // Add the character as data attribute for styling
                span.setAttribute('data-character', characterName.toLowerCase().replace(/ /g, '_'));
                
                // If this is inside a character-badge, make it bigger
                if (element.closest('.character-badge')) {
                    span.style.width = '64px';
                    span.style.height = '64px';
                    span.style.lineHeight = '64px';
                    span.style.fontSize = '24px';
                    span.style.margin = '0 auto 10px auto';
                    span.style.display = 'block';
                }
                
                this.parentNode.insertBefore(span, this.nextSibling);
            };
            
            // Add to the DOM
            element.appendChild(img);
        } else {
            // Fallback for unknown characters
            const span = document.createElement('span');
            span.className = 'character-icon-fallback';
            span.textContent = characterName ? characterName.charAt(0) : '?';
            
            if (characterName) {
                span.setAttribute('data-character', characterName.toLowerCase().replace(/ /g, '_'));
            }
            
            // If this is inside a character-badge, make it bigger
            if (element.closest('.character-badge')) {
                span.style.width = '64px';
                span.style.height = '64px';
                span.style.lineHeight = '64px';
                span.style.fontSize = '24px';
                span.style.margin = '0 auto 10px auto';
                span.style.display = 'block';
            }
            
            element.appendChild(span);
        }
    });
}
        
// Load More Games Button
let currentPage = 1;
const loadMoreGames = document.getElementById('loadMoreGames');

if (loadMoreGames) {
    loadMoreGames.addEventListener('click', function() {
        // Increment page counter
        currentPage++;
        
        // Show loading state
        loadMoreGames.textContent = 'Loading...';
        loadMoreGames.disabled = true;
        
        // Make API request - properly encode the player code
        // The issue is that '#' and other special characters need proper encoding
        const encodedPlayerCode = encodeURIComponent('{{ player_code }}');
        const apiUrl = `/api/player/${encodedPlayerCode}/games?page=${currentPage}`;
        
        console.log("Making request to:", apiUrl); // Debug
        
        fetch(apiUrl)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Server returned ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            // In the fetch response handler for loading more games
            .then(data => {
                console.log("Received data:", data); // Debug
                
                if (data.games && data.games.length > 0) {
                    const tableBody = document.getElementById('recentGamesTable');
                    
                    // Create a document fragment to hold all new rows
                    const fragment = document.createDocumentFragment();
                    
                    data.games.forEach(game => {
                        const row = document.createElement('tr');
                        const opponentTagEncoded = encodeURIComponent(game.opponent.player_tag);
                        
                        row.innerHTML = `
                            <td>${game.start_time}</td>
                            <td>
                                <span data-character-name="${game.player.character_name}" class="character-container"></span>
                                ${game.player.character_name}
                            </td>
                            <td>
                                <a href="/player/${opponentTagEncoded}">
                                    ${game.opponent.player_name}
                                </a>
                            </td>
                            <td>
                                <span data-character-name="${game.opponent.character_name}" class="character-container"></span>
                                ${game.opponent.character_name}
                            </td>
                            <td>
                                ${game.result === 'Win' 
                                    ? '<span class="badge bg-success">Win</span>' 
                                    : '<span class="badge bg-danger">Loss</span>'}
                            </td>
                        `;
                        fragment.appendChild(row);
                    });
                    
                    // Append all rows at once
                    tableBody.appendChild(fragment);
                    
                    // Initialize the character icons ONLY for the newly added rows
                    initializeCharacterIcons(tableBody);
                    
                    // Reset button state
                    loadMoreGames.disabled = false;
                    loadMoreGames.textContent = 'Load More Games';
                    
                    // Disable if no more pages
                    if (currentPage >= data.total_pages) {
                        loadMoreGames.disabled = true;
                        loadMoreGames.textContent = 'No More Games';
                    }
                } else {
                    // No more games
                    loadMoreGames.disabled = true;
                    loadMoreGames.textContent = 'No More Games';
                }
            })
            .catch(error => {
                console.error('Error loading more games:', error);
                loadMoreGames.textContent = 'Error - Try Again';
                loadMoreGames.classList.remove('btn-primary');
                loadMoreGames.classList.add('btn-danger');
                loadMoreGames.disabled = false;
                
                // Reset so user can try again
                currentPage--;
            });
    });
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    initializeCharacterIcons();
});
</script>
{% endblock %}