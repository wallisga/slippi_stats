{% extends "layouts/player.html" %}

{% block title %}{{ player_code }} | Slippi Stats{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/player.css') }}">
{% endblock %}

{% block content %}
<!-- Player Header -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="player-header">
            <h1 class="display-4">{{ player_code }}</h1>
            <p class="lead">Player Statistics</p>
            <a href="/player/{{ player_code|urlencode }}/detailed" class="btn btn-primary btn-lg">
                <i class="bi bi-graph-up me-2"></i>Detailed Analysis
            </a>
        </div>
    </div>
</div>

{% if stats and stats.total_games > 0 %}
<!-- Performance Overview -->
<div class="row mb-4">
    <!-- Overall Stats Card -->
    <div class="col-md-4 mb-4">
        <div class="card stat-card h-100">
            <div class="card-body text-center">
                <h5 class="card-title">Overall Performance</h5>
                <div class="win-rate-circle my-3" style="--win-rate: {{ stats.win_rate }}">
                    <div class="win-rate-inner">{{ (stats.win_rate * 100) | round(1) }}%</div>
                </div>
                <p class="card-text">
                    <strong>{{ stats.wins }}</strong> wins out of <strong>{{ stats.total_games }}</strong> games
                </p>
            </div>
        </div>
    </div>

    <!-- Most Played Character Card -->
    {% if stats.most_played_character %}
    <div class="col-md-4 mb-4">
        <div class="card stat-card h-100">
            <div class="card-body text-center">
                <h5 class="card-title">Most Played Character</h5>
                <div class="character-badge">
                    <span data-character-name="{{ stats.most_played_character }}" class="character-container"></span>
                    <h3 class="character-name">{{ stats.most_played_character }}</h3>
                </div>
                <div class="character-stats">
                    <div class="stat-item">
                        <span class="stat-number">{{ stats.character_stats[stats.most_played_character].games }}</span>
                        <span class="stat-label">games</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number">{{ (stats.character_stats[stats.most_played_character].win_rate * 100) | round(1) }}%</span>
                        <span class="stat-label">win rate</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Best Character Card -->
    {% if stats.best_character %}
    <div class="col-md-4 mb-4">
        <div class="card stat-card h-100">
            <div class="card-body text-center">
                <h5 class="card-title">Best Character</h5>
                <div class="character-badge">
                    <span data-character-name="{{ stats.best_character }}" class="character-container"></span>
                    <h3 class="character-name">{{ stats.best_character }}</h3>
                </div>
                <div class="character-stats">
                    <div class="stat-item">
                        <span class="stat-number">{{ stats.character_stats[stats.best_character].games }}</span>
                        <span class="stat-label">games</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number">{{ (stats.character_stats[stats.best_character].win_rate * 100) | round(1) }}%</span>
                        <span class="stat-label">win rate</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Special Stats Row -->
<div class="row mb-4">
    <!-- Rising Star Card -->
    {% if stats.rising_star %}
    <div class="col-md-4 mb-4">
        <div class="card stat-card special-card rising-star h-100">
            <div class="card-body text-center">
                <h5 class="card-title">
                    <i class="bi bi-star-fill me-2"></i>On The Rise
                </h5>
                <div class="character-badge">
                    <span data-character-name="{{ stats.rising_star }}" class="character-container"></span>
                    <h3 class="character-name">{{ stats.rising_star }}</h3>
                </div>
                <p class="card-text">
                    Best recent performance
                    <br>
                    <small>Based on last 30 games</small>
                </p>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Rival Card -->
    {% if stats.rival %}
    <div class="col-md-4 mb-4">
        <div class="card stat-card special-card rival h-100">
            <div class="card-body text-center">
                <h5 class="card-title">
                    <i class="bi bi-lightning-fill me-2"></i>Rival
                </h5>
                <div class="rival-info">
                    <div class="rival-header">
                        <strong>{{ stats.rival.opponent_tag }}</strong>
                        <span class="rival-character">
                            <span data-character-name="{{ stats.rival.opponent_char }}" class="character-container"></span>
                            {{ stats.rival.opponent_char }}
                        </span>
                    </div>
                    <div class="rival-stats">
                        <div class="stat-number">{{ (stats.rival.win_rate * 100) | round(1) }}%</div>
                        <div class="stat-label">win rate against them</div>
                        <small>{{ stats.rival.wins }} wins out of {{ stats.rival.games }} games</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Worst Character Card -->
    {% if stats.worst_character %}
    <div class="col-md-4 mb-4">
        <div class="card stat-card special-card needs-work h-100">
            <div class="card-body text-center">
                <h5 class="card-title">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>Needs Work
                </h5>
                <div class="character-badge">
                    <span data-character-name="{{ stats.worst_character }}" class="character-container"></span>
                    <h3 class="character-name">{{ stats.worst_character }}</h3>
                </div>
                <div class="character-stats">
                    <div class="stat-item">
                        <span class="stat-number">{{ stats.character_stats[stats.worst_character].games }}</span>
                        <span class="stat-label">games</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number">{{ (stats.character_stats[stats.worst_character].win_rate * 100) | round(1) }}%</span>
                        <span class="stat-label">win rate</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Charts Row -->
<div class="row mb-4">
    <!-- Character Stats Chart -->
    {% if stats.character_stats and stats.character_stats|length > 0 %}
    <div class="col-md-6 mb-4">
        <div class="card stat-card">
            <div class="card-header">
                <h5><i class="bi bi-bar-chart-fill me-2"></i>Character Performance</h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="characterStatsChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Stage Stats Chart -->
    {% if stats.stage_stats and stats.stage_stats|length > 0 %}
    <div class="col-md-6 mb-4">
        <div class="card stat-card">
            <div class="card-header">
                <h5><i class="bi bi-geo-alt-fill me-2"></i>Stage Performance</h5>
            </div>
            <div class="card-body">
                {% if stats.best_stage or stats.worst_stage %}
                <div class="row mb-3">
                    {% if stats.best_stage %}
                    <div class="col-md-6">
                        <div class="stage-highlight best-stage">
                            <div class="stage-label">Best Stage</div>
                            <div class="stage-info">
                                <div class="stage-id">Stage {{ stats.best_stage.id }}</div>
                                <div class="stage-winrate">{{ (stats.best_stage.win_rate * 100) | round(1) }}% win rate</div>
                                <div class="stage-games">{{ stats.best_stage.games }} games</div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    {% if stats.worst_stage %}
                    <div class="col-md-6">
                        <div class="stage-highlight worst-stage">
                            <div class="stage-label">Worst Stage</div>
                            <div class="stage-info">
                                <div class="stage-id">Stage {{ stats.worst_stage.id }}</div>
                                <div class="stage-winrate">{{ (stats.worst_stage.win_rate * 100) | round(1) }}% win rate</div>
                                <div class="stage-games">{{ stats.worst_stage.games }} games</div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
                {% endif %}
                <div class="chart-container">
                    <canvas id="stageStatsChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Recent Games -->
<div class="row">
    <div class="col-md-12 mb-4">
        <div class="card stat-card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5><i class="bi bi-clock-history me-2"></i>Recent Games</h5>
                <span class="badge bg-primary">{{ recent_games|length }} shown</span>
            </div>
            <div class="card-body">
                {% if recent_games and recent_games|length > 0 %}
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Your Character</th>
                                <th>Opponent</th>
                                <th>Their Character</th>
                                <th>Result</th>
                                <th>Duration</th>
                            </tr>
                        </thead>
                        <tbody id="recentGamesTable">
                            {% for game in recent_games %}
                            <tr>
                                <td class="game-time">{{ game.start_time }}</td>
                                <td>
                                    <span data-character-name="{{ game.player.character_name }}" class="character-container"></span>
                                    {{ game.player.character_name }}
                                </td>
                                <td>
                                    {% set opponent_tag_encoded = game.opponent.player_tag | urlencode %}
                                    <a href="/player/{{ opponent_tag_encoded }}" class="player-link">
                                        {{ game.opponent.player_name }}
                                    </a>
                                </td>
                                <td>
                                    <span data-character-name="{{ game.opponent.character_name }}" class="character-container"></span>
                                    {{ game.opponent.character_name }}
                                </td>
                                <td>
                                    {% if game.result == 'Win' %}
                                    <span class="badge bg-success"><i class="bi bi-trophy-fill me-1"></i>Win</span>
                                    {% else %}
                                    <span class="badge bg-danger"><i class="bi bi-x-circle-fill me-1"></i>Loss</span>
                                    {% endif %}
                                </td>
                                <td class="game-duration">{{ (game.game_duration_seconds / 60) | round(1) }}m</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div class="d-flex justify-content-center mt-3">
                    <button id="loadMoreGames" class="btn btn-primary" data-player="{{ player_code }}">
                        <i class="bi bi-arrow-down-circle me-2"></i>Load More Games
                    </button>
                </div>
                {% else %}
                <div class="no-data-message">
                    <i class="bi bi-inbox me-2"></i>
                    <span>No recent games found for this player.</span>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{% else %}
<!-- No Data State -->
<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-body">
                <div class="no-data-message large">
                    <i class="bi bi-exclamation-circle display-1 text-warning mb-3"></i>
                    <h3>No Statistics Available</h3>
                    <p class="lead">This player has no recorded games yet or not enough data to generate statistics.</p>
                    <div class="mt-4">
                        <a href="/" class="btn btn-primary btn-lg me-3">
                            <i class="bi bi-house-fill me-2"></i>Return to Home
                        </a>
                        <a href="/players" class="btn btn-outline-secondary btn-lg">
                            <i class="bi bi-people-fill me-2"></i>Browse Players
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/pages/player.js') }}"></script>
<script>
    // Pass data to JavaScript
    window.PLAYER_DATA = {
        code: '{{ player_code }}',
        encodedCode: '{{ encoded_player_code }}',
        stats: {{ stats | tojson if stats else '{}' }},
        hasCharts: {{ 'true' if (stats and stats.character_stats) else 'false' }}
    };
</script>
{% endblock %}