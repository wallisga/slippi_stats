<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ player_code }} | {{ character_name }} Stats | Slippi Stats</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.0/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            min-height: 100vh;
        }
        
        .stat-card {
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.2s;
            margin-bottom: 1.5rem;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .win-rate-circle {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: conic-gradient(#198754 0% calc(var(--win-rate) * 100%), #dee2e6 calc(var(--win-rate) * 100%) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
            position: relative;
        }
        
        .win-rate-inner {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
        }
        
        .character-badge {
            text-align: center;
            margin-bottom: 15px;
        }
        
        .character-banner {
            background-color: #f8f9fa;
            border-radius: 10px;
            padding: 2rem 0;
            margin-bottom: 2rem;
            text-align: center;
        }
        
        .character-icon {
            margin-right: 8px;
            vertical-align: middle;
        }
        
        .character-icon-fallback {
            display: inline-block;
            width: 24px;
            height: 24px;
            background-color: #f8f9fa;
            border-radius: 50%;
            margin-right: 8px;
            vertical-align: middle;
            text-align: center;
            line-height: 24px;
            font-size: 10px;
            font-weight: bold;
            color: #495057;
        }
        
        .character-banner .character-icon,
        .character-badge .character-icon {
            width: 96px;
            height: 96px;
        }
        
        .character-banner .character-icon-fallback,
        .character-badge .character-icon-fallback {
            width: 96px;
            height: 96px;
            line-height: 96px;
            font-size: 36px;
            margin: 0 auto 15px auto;
            display: block;
        }
        
        .matchup-bar {
            height: 24px;
            background-color: #f8f9fa;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        
        .matchup-fill {
            height: 100%;
            display: flex;
            align-items: center;
            padding-left: 8px;
            font-weight: bold;
            color: white;
        }
        
        .matchup-win {
            background-color: #198754;
        }
        
        .matchup-loss {
            background-color: #dc3545;
        }
        
        .matchup-even {
            background-color: #ffc107;
            color: #212529;
        }
        
        .scrollable-table {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .character-container {
            display: inline-flex;
            align-items: center;
        }
        
        /* Character-specific fallback colors */
        .character-icon-fallback[data-character="fox"] {
            background-color: #fd7e14;
            color: white;
        }
        
        .character-icon-fallback[data-character="falco"] {
            background-color: #0d6efd;
            color: white;
        }
        
        .character-icon-fallback[data-character="marth"] {
            background-color: #0dcaf0;
            color: white;
        }
        
        .character-icon-fallback[data-character="captain_falcon"] {
            background-color: #dc3545;
            color: white;
        }
        
        .character-icon-fallback[data-character="jigglypuff"] {
            background-color: #d63384;
            color: white;
        }
        
        .character-icon-fallback[data-character="peach"] {
            background-color: #ffc107;
        }
        
        .character-icon-fallback[data-character="sheik"] {
            background-color: #6f42c1;
            color: white;
        }
        
        .character-icon-fallback[data-character="ice_climbers"] {
            background-color: #6c757d;
            color: white;
        }
        
        .dropdown-item.active {
            background-color: #0d6efd;
            color: white;
        }
        
        .navbar-search {
            max-width: 300px;
        }
        
        .move-stat {
            margin-bottom: 1rem;
        }
        
        .move-name {
            font-weight: bold;
        }
        
        .move-usage {
            height: 20px;
            background-color: #e9ecef;
            border-radius: 3px;
            margin-top: 5px;
            overflow: hidden;
        }
        
        .move-usage-fill {
            height: 100%;
            background-color: #0d6efd;
        }
        
        .progress-small {
            height: 8px;
        }
    </style>
</head>
<body>
    <!-- Navbar (Same as in the dropdown example) -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">Slippi Stats</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/download">Download</a>
                    </li>                    
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle active" href="#" id="playerDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            Players
                        </a>
                        <ul class="dropdown-menu" aria-labelledby="playerDropdown">
                            <li><a class="dropdown-item" href="/players">Player Index</a></li>
                            <!-- If viewing a player, show these options -->
                            <li><hr class="dropdown-divider"></li>
                            <li><h6 class="dropdown-header">{{ player_code }}</h6></li>
                            <li><a class="dropdown-item" href="/player/{{ player_code|urlencode }}">Basic Profile</a></li>
                            <li><a class="dropdown-item" href="/player/{{ player_code|urlencode }}/detailed">Detailed Stats</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><h6 class="dropdown-header">Character Stats</h6></li>
                            {% for char in character_list %}
                            <li><a class="dropdown-item {% if char == character_name %}active{% endif %}" href="/player/{{ player_code|urlencode }}/character/{{ char|urlencode }}">
                                <span data-character-name="{{ char }}" class="character-container"></span> {{ char }}
                            </a></li>
                            {% endfor %}
                        </ul>
                    </li>
                </ul>
                <form class="d-flex navbar-search" id="playerSearchForm">
                    <input class="form-control me-2" type="search" placeholder="Find Player..." aria-label="Search" id="playerCodeInput">
                    <button class="btn btn-outline-light" type="submit"><i class="bi bi-search"></i></button>
                </form>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Character Banner -->
        <div class="character-banner">
            <span data-character-name="{{ character_name }}" class="character-container"></span>
            <h1 class="display-4">{{ character_name }}</h1>
            <p class="lead">{{ player_code }}'s Character Stats</p>
        </div>
        
        <!-- Summary Row -->
        <div class="row mb-4">
            <!-- Overall Performance -->
            <div class="col-md-4 mb-4">
                <div class="card stat-card h-100">
                    <div class="card-body text-center">
                        <h5 class="card-title">Overall Performance</h5>
                        <div class="win-rate-circle my-3" style="--win-rate: {{ character_stats.win_rate }}">
                            <div class="win-rate-inner">{{ (character_stats.win_rate * 100) | round(1) }}%</div>
                        </div>
                        <p class="card-text">
                            <strong>{{ character_stats.wins }}</strong> wins out of <strong>{{ character_stats.games }}</strong> games
                        </p>
                    </div>
                </div>
            </div>
            
            <!-- Usage Stats -->
            <div class="col-md-4 mb-4">
                <div class="card stat-card h-100">
                    <div class="card-header">
                        <h5>Character Usage</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-flex justify-content-between mb-2">
                            <span>Usage Rate:</span>
                            <strong>{{ (character_stats.games / total_games * 100) | round(1) }}%</strong>
                        </div>
                        <div class="progress mb-3">
                            <div class="progress-bar" role="progressbar" style="width: {{ (character_stats.games / total_games * 100) }}%" 
                                aria-valuenow="{{ (character_stats.games / total_games * 100) | round(1) }}" aria-valuemin="0" aria-valuemax="100">
                            </div>
                        </div>
                        <p class="small text-muted mb-0">
                            Played {{ character_stats.games }} out of {{ total_games }} total games
                        </p>
                        {% if character_stats.trend %}
                        <div class="mt-3">
                            <div class="d-flex justify-content-between mb-2">
                                <span>Recent Trend:</span>
                                <strong class="{% if character_stats.trend > 0 %}text-success{% elif character_stats.trend < 0 %}text-danger{% endif %}">
                                    {% if character_stats.trend > 0 %}+{% endif %}{{ character_stats.trend | round(1) }}%
                                </strong>
                            </div>
                            <div class="progress progress-small">
                                <div class="progress-bar {% if character_stats.trend > 0 %}bg-success{% elif character_stats.trend < 0 %}bg-danger{% else %}bg-secondary{% endif %}" 
                                    role="progressbar" style="width: {{ (character_stats.trend|abs / 100 * 50 + 50) }}%" 
                                    aria-valuenow="{{ character_stats.trend }}" aria-valuemin="-100" aria-valuemax="100">
                                </div>
                            </div>
                            <p class="small text-muted mt-1">
                                Based on last 30 days vs. overall performance
                            </p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- Best Matchup -->
            <div class="col-md-4 mb-4">
                <div class="card stat-card h-100">
                    <div class="card-header">
                        <h5>Top Matchups</h5>
                    </div>
                    <div class="card-body">
                        {% if character_stats.matchups and character_stats.matchups|length > 0 %}
                        <div class="best-matchup mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span>Best Matchup:</span>
                                <span data-character-name="{{ character_stats.best_matchup.character }}" class="character-container"></span>
                            </div>
                            <div class="matchup-bar">
                                <div class="matchup-fill matchup-win" style="width: {{ character_stats.best_matchup.win_rate * 100 }}%">
                                    {{ (character_stats.best_matchup.win_rate * 100) | round(1) }}% vs {{ character_stats.best_matchup.character }}
                                </div>
                            </div>
                            <p class="small text-muted">
                                {{ character_stats.best_matchup.wins }} wins out of {{ character_stats.best_matchup.games }} games
                            </p>
                        </div>
                        
                        <div class="worst-matchup">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span>Worst Matchup:</span>
                                <span data-character-name="{{ character_stats.worst_matchup.character }}" class="character-container"></span>
                            </div>
                            <div class="matchup-bar">
                                <div class="matchup-fill matchup-loss" style="width: {{ character_stats.worst_matchup.win_rate * 100 }}%">
                                    {{ (character_stats.worst_matchup.win_rate * 100) | round(1) }}% vs {{ character_stats.worst_matchup.character }}
                                </div>
                            </div>
                            <p class="small text-muted">
                                {{ character_stats.worst_matchup.wins }} wins out of {{ character_stats.worst_matchup.games }} games
                            </p>
                        </div>
                        {% else %}
                        <p>No matchup data available.</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Data Row -->
        <div class="row mb-4">
            <!-- Matchup Chart -->
            <div class="col-md-6 mb-4">
                <div class="card stat-card h-100">
                    <div class="card-header">
                        <h5>Matchup Win Rates</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container" style="position: relative; height:350px;">
                            <canvas id="matchupChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Time Trend -->
            <div class="col-md-6 mb-4">
                <div class="card stat-card h-100">
                    <div class="card-header">
                        <h5>Performance Over Time</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container" style="position: relative; height:350px;">
                            <canvas id="timeChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Move Stats Row -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card stat-card">
                    <div class="card-header">
                        <h5>Move Usage Statistics</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="mb-3">Neutral Game</h6>
                                <div class="move-stat">
                                    <div class="d-flex justify-content-between">
                                        <span class="move-name">Neutral Air</span>
                                        <span>24%</span>
                                    </div>
                                    <div class="move-usage">
                                        <div class="move-usage-fill" style="width: 24%"></div>
                                    </div>
                                </div>
                                <div class="move-stat">
                                    <div class="d-flex justify-content-between">
                                        <span class="move-name">Down Tilt</span>
                                        <span>18%</span>
                                    </div>
                                    <div class="move-usage">
                                        <div class="move-usage-fill" style="width: 18%"></div>
                                    </div>
                                </div>
                                <div class="move-stat">
                                    <div class="d-flex justify-content-between">
                                        <span class="move-name">Grab</span>
                                        <span>15%</span>
                                    </div>
                                    <div class="move-usage">
                                        <div class="move-usage-fill" style="width: 15%"></div>
                                    </div>
                                </div>
                                <div class="move-stat">
                                    <div class="d-flex justify-content-between">
                                        <span class="move-name">Forward Air</span>
                                        <span>10%</span>
                                    </div>
                                    <div class="move-usage">
                                        <div class="move-usage-fill" style="width: 10%"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6 class="mb-3">Kill Moves</h6>
                                <div class="move-stat">
                                    <div class="d-flex justify-content-between">
                                        <span class="move-name">Up Smash</span>
                                        <span>35%</span>
                                    </div>
                                    <div class="move-usage">
                                        <div class="move-usage-fill" style="width: 35%"></div>
                                    </div>
                                </div>
                                <div class="move-stat">
                                    <div class="d-flex justify-content-between">
                                        <span class="move-name">Back Air</span>
                                        <span>28%</span>
                                    </div>
                                    <div class="move-usage">
                                        <div class="move-usage-fill" style="width: 28%"></div>
                                    </div>
                                </div>
                                <div class="move-stat">
                                    <div class="d-flex justify-content-between">
                                        <span class="move-name">Forward Smash</span>
                                        <span>12%</span>
                                    </div>
                                    <div class="move-usage">
                                        <div class="move-usage-fill" style="width: 12%"></div>
                                    </div>
                                </div>
                                <div class="move-stat">
                                    <div class="d-flex justify-content-between">
                                        <span class="move-name">Down Smash</span>
                                        <span>8%</span>
                                    </div>
                                    <div class="move-usage">
                                        <div class="move-usage-fill" style="width: 8%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Recent Games Row -->
        <div class="row">
            <div class="col-md-12">
                <div class="card stat-card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Recent Games with {{ character_name }}</h5>
                        <span class="badge bg-primary">{{ character_stats.games }} Games</span>
                    </div>
                    <div class="card-body p-0">
                        <div class="scrollable-table">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Date</th>
                                        <th>Opponent</th>
                                        <th>Opponent's Character</th>
                                        <th>Stage</th>
                                        <th>Result</th>
                                    </tr>
                                </thead>
                                <tbody id="recentGamesTable">
                                    {% for game in recent_games %}
                                    <tr>
                                        <td>{{ game.date }}</td>
                                        <td>
                                            <a href="/player/{{ game.opponent_code|urlencode }}">{{ game.opponent }}</a>
                                        </td>
                                        <td>
                                            <span data-character-name="{{ game.opponent_character }}" class="character-container"></span>
                                            {{ game.opponent_character }}
                                        </td>
                                        <td>{{ game.stage }}</td>
                                        <td>
                                            {% if game.result == 'Win' %}
                                            <span class="badge bg-success">Win</span>
                                            {% else %}
                                            <span class="badge bg-danger">Loss</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="card-footer text-center">
                        <button id="loadMoreGames" class="btn btn-primary">Load More Games</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer class="bg-dark text-white py-4 mt-5">
        <div class="container text-center">
            <p>Slippi Stats - A tool for Super Smash Bros. Melee statistics</p>
            <p class="small">Powered by the Slippi Stats Collector</p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Character icon handling
        function initializeCharacterIcons(container = document) {
            // Define the character mapping based on the config
            const characterMapping = {
                "Mario": "Mario",
                "Fox": "Fox",
                "Captain Falcon": "Captain Falcon",
                "Donkey Kong": "Donkey Kong",
                "Kirby": "Kirby",
                "Bowser": "Bowser",
                "Link": "Link",
                "Sheik": "Sheik", 
                "Ness": "Ness",
                "Peach": "Peach",
                "Ice Climbers": "Ice Climbers",
                "Yoshi": "Yoshi",
                "Pikachu": "Pikachu",
                "Samus": "Samus",
                "Jigglypuff": "Jigglypuff",
                "Mewtwo": "Mewtwo",
                "Luigi": "Luigi",
                "Marth": "Marth",
                "Zelda": "Zelda",
                "Young Link": "Young Link",
                "Doctor Mario": "Doctor Mario",
                "Dr. Mario": "Doctor Mario",
                "Falco": "Falco",
                "Pichu": "Pichu",
                "Game & Watch": "Game & Watch",
                "Mr. Game & Watch": "Game & Watch",
                "Ganondorf": "Ganondorf",
                "Roy": "Roy"
            };

            // Only select elements that haven't been processed yet
            container.querySelectorAll('[data-character-name]:not([data-icon-processed])').forEach(function(element) {
                // Mark as processed to avoid duplicate icons
                element.setAttribute('data-icon-processed', 'true');
                
                const characterName = element.getAttribute('data-character-name');
                if (characterName && characterMapping[characterName]) {
                    // Create the image element
                    const img = document.createElement('img');
                    img.src = `/static/icons/character/neutral ${characterMapping[characterName]}.png`;
                    img.alt = characterName;
                    
                    // If this is inside a character-banner or badge, make it bigger
                    if (element.closest('.character-banner') || element.closest('.character-badge')) {
                        img.width = 96;
                        img.height = 96;
                    } else {
                        img.width = 24;
                        img.height = 24;
                    }
                    
                    img.className = 'character-icon';
                    
                    // Add error handling
                    img.onerror = function() {
                        // If image fails to load, replace with character initial
                        this.style.display = 'none';
                        const span = document.createElement('span');
                        span.className = 'character-icon-fallback';
                        span.textContent = characterName.charAt(0);
                        
                        // Add the character as data attribute for styling
                        span.setAttribute('data-character', characterName.toLowerCase().replace(/ /g, '_'));
                        
                        // If this is inside a character-banner or badge, make it bigger
                        if (element.closest('.character-banner') || element.closest('.character-badge')) {
                            span.style.width = '96px';
                            span.style.height = '96px';
                            span.style.lineHeight = '96px';
                            span.style.fontSize = '36px';
                            span.style.margin = '0 auto 10px auto';
                            span.style.display = 'block';
                        }
                        
                        this.parentNode.insertBefore(span, this.nextSibling);
                    };
                    
                    // Add to the DOM
                    element.appendChild(img);
                } else {
                    // Fallback for unknown characters
                    const span = document.createElement('span');
                    span.className = 'character-icon-fallback';
                    span.textContent = characterName ? characterName.charAt(0) : '?';
                    
                    if (characterName) {
                        span.setAttribute('data-character', characterName.toLowerCase().replace(/ /g, '_'));
                    }
                    
                    // If this is inside a character-banner or badge, make it bigger
                    if (element.closest('.character-banner') || element.closest('.character-badge')) {
                        span.style.width = '96px';
                        span.style.height = '96px';
                        span.style.lineHeight = '96px';
                        span.style.fontSize = '36px';
                        span.style.margin = '0 auto 15px auto';
                        span.style.display = 'block';
                    }
                    
                    element.appendChild(span);
                }
            });
        }
        
        // Initialize charts
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize character icons
            initializeCharacterIcons();
            
            // Matchup chart
            const matchupCtx = document.getElementById('matchupChart').getContext('2d');
            const matchupData = {
                labels: [
                    {% for matchup in character_stats.matchups %}
                    '{{ matchup.character }}',
                    {% endfor %}
                ],
                datasets: [{
                    label: 'Win Rate (%)',
                    data: [
                        {% for matchup in character_stats.matchups %}
                        {{ matchup.win_rate * 100 }},
                        {% endfor %}
                    ],
                    backgroundColor: [
                        {% for matchup in character_stats.matchups %}
                        {% if matchup.win_rate >= 0.6 %}
                        'rgba(40, 167, 69, 0.6)',  // Green for good matchups
                        {% elif matchup.win_rate >= 0.4 %}
                        'rgba(255, 193, 7, 0.6)',  // Yellow for even matchups
                        {% else %}
                        'rgba(220, 53, 69, 0.6)',  // Red for bad matchups
                        {% endif %}
                        {% endfor %}
                    ],
                    borderColor: [
                        {% for matchup in character_stats.matchups %}
                        {% if matchup.win_rate >= 0.6 %}
                        'rgba(40, 167, 69, 1)',
                        {% elif matchup.win_rate >= 0.4 %}
                        'rgba(255, 193, 7, 1)',
                        {% else %}
                        'rgba(220, 53, 69, 1)',
                        {% endif %}
                        {% endfor %}
                    ],
                    borderWidth: 1
                }]
            };
            
            new Chart(matchupCtx, {
                type: 'bar',
                data: matchupData,
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    scales: {
                        x: {
                            beginAtZero: true,
                            max: 100,
                            title: {
                                display: true,
                                text: 'Win Rate (%)'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Opponent Character'
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                afterLabel: function(context) {
                                    const idx = context.dataIndex;
                                    const matchup = {{ character_stats.matchups|tojson }};
                                    return `Games: ${matchup[idx].games}, Wins: ${matchup[idx].wins}`;
                                }
                            }
                        },
                        legend: {
                            display: false
                        }
                    }
                }
            });
            
            // Time chart
            const timeCtx = document.getElementById('timeChart').getContext('2d');
            const timeData = {
                labels: [
                    {% for date, stats in character_stats.time_stats.items() %}
                    '{{ date }}',
                    {% endfor %}
                ],
                datasets: [{
                    label: 'Win Rate (%)',
                    data: [
                        {% for date, stats in character_stats.time_stats.items() %}
                        {{ stats.win_rate * 100 }},
                        {% endfor %}
                    ],
                    fill: false,
                    borderColor: 'rgba(40, 167, 69, 1)',
                    tension: 0.1,
                    yAxisID: 'y'
                }, {
                    label: 'Games Played',
                    data: [
                        {% for date, stats in character_stats.time_stats.items() %}
                        {{ stats.games }},
                        {% endfor %}
                    ],
                    type: 'bar',
                    backgroundColor: 'rgba(13, 110, 253, 0.5)',
                    yAxisID: 'y1'
                }]
            };
            
            new Chart(timeCtx, {
                type: 'line',
                data: timeData,
                options: {
                    responsive: true,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            min: 0,
                            max: 100,
                            title: {
                                display: true,
                                text: 'Win Rate (%)'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            grid: {
                                drawOnChartArea: false,
                            },
                            title: {
                                display: true,
                                text: 'Games Played'
                            }
                        }
                    }
                }
            });
        });
        
        // Player search form
        document.getElementById('playerSearchForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const playerCode = document.getElementById('playerCodeInput').value.trim();
            if (playerCode) {
                // Encode the player tag for URL
                const encodedTag = encodeURIComponent(playerCode);
                window.location.href = `/player/${encodedTag}`;
            }
        });
        
        // Load More Games Button
        let currentPage = 1;
        const loadMoreGames = document.getElementById('loadMoreGames');

        if (loadMoreGames) {
            loadMoreGames.addEventListener('click', function() {
                // Increment page counter
                currentPage++;
                
                // Show loading state
                loadMoreGames.textContent = 'Loading...';
                loadMoreGames.disabled = true;
                
                // Make API request
                const encodedPlayerCode = encodeURIComponent('{{ player_code }}');
                const encodedCharacter = encodeURIComponent('{{ character_name }}');
                const apiUrl = `/api/player/${encodedPlayerCode}/character/${encodedCharacter}/games?page=${currentPage}`;
                
                fetch(apiUrl)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`Server returned ${response.status}: ${response.statusText}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.games && data.games.length > 0) {
                            const tableBody = document.getElementById('recentGamesTable');
                            
                            // Create a document fragment to hold all new rows
                            const fragment = document.createDocumentFragment();
                            
                            data.games.forEach(game => {
                                const row = document.createElement('tr');
                                const opponentCodeEncoded = encodeURIComponent(game.opponent_code);
                                
                                row.innerHTML = `
                                    <td>${game.date}</td>
                                    <td>
                                        <a href="/player/${opponentCodeEncoded}">${game.opponent}</a>
                                    </td>
                                    <td>
                                        <span data-character-name="${game.opponent_character}" class="character-container"></span>
                                        ${game.opponent_character}
                                    </td>
                                    <td>${game.stage}</td>
                                    <td>
                                        ${game.result === 'Win' 
                                            ? '<span class="badge bg-success">Win</span>' 
                                            : '<span class="badge bg-danger">Loss</span>'}
                                    </td>
                                `;
                                fragment.appendChild(row);
                            });
                            
                            // Append all rows at once
                            tableBody.appendChild(fragment);
                            
                            // Initialize the character icons for new rows
                            initializeCharacterIcons(tableBody);
                            
                            // Reset button state
                            loadMoreGames.disabled = false;
                            loadMoreGames.textContent = 'Load More Games';
                            
                            // Disable if no more pages
                            if (currentPage >= data.total_pages) {
                                loadMoreGames.disabled = true;
                                loadMoreGames.textContent = 'No More Games';
                            }
                        } else {
                            // No more games
                            loadMoreGames.disabled = true;
                            loadMoreGames.textContent = 'No More Games';
                        }
                    })
                    .catch(error => {
                        console.error('Error loading more games:', error);
                        loadMoreGames.textContent = 'Error - Try Again';
                        loadMoreGames.classList.remove('btn-primary');
                        loadMoreGames.classList.add('btn-danger');
                        loadMoreGames.disabled = false;
                        
                        // Reset so user can try again
                        currentPage--;
                    });
            });
        }
    </script>
</body>
</html>