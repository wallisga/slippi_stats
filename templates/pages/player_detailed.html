{% extends "layouts/player.html" %}

{% block title %}{{ player_code }} | Detailed Stats | Slippi Stats{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/player_detailed.css') }}">
{% endblock %}

{% block content %}
<!-- Horizontal Filter Section -->
<div class="card mb-4 filter-card">
    <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
                <i class="bi bi-funnel-fill me-2"></i>Advanced Filters
            </h5>
            <button class="btn btn-outline-primary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#filterCollapse" aria-expanded="true">
                <i class="bi bi-chevron-up" id="filterToggleIcon"></i>
            </button>
        </div>
    </div>
    <div class="collapse show" id="filterCollapse">
        <div class="card-body">
            <div class="row">
                <!-- Your Character Filter -->
                <div class="col-md-4 mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <label class="form-label mb-0 fw-semibold">Your Character</label>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="characterFilterToggle" checked>
                            <label class="form-check-label small" for="characterFilterToggle">Multi-select</label>
                        </div>
                    </div>
                    <select class="form-select form-select-sm" id="characterFilter" style="display: none;">
                        <option value="all" selected>All Characters</option>
                    </select>
                    <div class="filter-checkboxes-horizontal" id="characterCheckboxes">
                        <div class="checkbox-item select-all-option">
                            <div class="form-check">
                                <input class="form-check-input select-all" type="checkbox" id="selectAllCharacters" checked>
                                <label class="form-check-label small" for="selectAllCharacters">All Characters</label>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Opponent Filter -->
                <div class="col-md-4 mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <label class="form-label mb-0 fw-semibold">Opponent</label>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="opponentFilterToggle" checked>
                            <label class="form-check-label small" for="opponentFilterToggle">Multi-select</label>
                        </div>
                    </div>
                    <select class="form-select form-select-sm" id="opponentFilter" style="display: none;">
                        <option value="all" selected>All Opponents</option>
                    </select>
                    <div class="filter-checkboxes-horizontal" id="opponentCheckboxes">
                        <div class="checkbox-item select-all-option">
                            <div class="form-check">
                                <input class="form-check-input select-all" type="checkbox" id="selectAllOpponents" checked>
                                <label class="form-check-label small" for="selectAllOpponents">All Opponents</label>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Opponent's Character Filter -->
                <div class="col-md-4 mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <label class="form-label mb-0 fw-semibold">Opponent's Character</label>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="opponentCharFilterToggle" checked>
                            <label class="form-check-label small" for="opponentCharFilterToggle">Multi-select</label>
                        </div>
                    </div>
                    <select class="form-select form-select-sm" id="opponentCharacterFilter" style="display: none;">
                        <option value="all" selected>All Characters</option>
                    </select>
                    <div class="filter-checkboxes-horizontal" id="opponentCharCheckboxes">
                        <div class="checkbox-item select-all-option">
                            <div class="form-check">
                                <input class="form-check-input select-all" type="checkbox" id="selectAllOpponentChars" checked>
                                <label class="form-check-label small" for="selectAllOpponentChars">All Characters</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Filter Buttons -->
            <div class="row">
                <div class="col-12">
                    <div class="d-flex gap-2 justify-content-end">
                        <button id="resetFilters" class="btn btn-outline-secondary btn-sm">Reset Filters</button>
                        <button id="applyFilters" class="btn btn-primary btn-sm">Apply Filters</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Top Summary Row -->
<div class="row mb-4">
    <div class="col-md-5">
        <div class="card stat-card h-100">
            <div class="card-body text-center">
                <h5 class="card-title">Overall Performance</h5>
                <div class="win-rate-circle my-3" id="overall-win-rate-circle" style="--win-rate: 0">
                    <div class="win-rate-inner" id="overall-win-rate">0%</div>
                </div>
                <p class="card-text" id="overall-stats">
                    <strong>0</strong> wins out of <strong>0</strong> games
                </p>
            </div>
        </div>
    </div>
    
    <div class="col-md-7">
        <div class="card stat-card h-100">
            <div class="card-header">
                <h5>Current Filter Results</h5>
            </div>
            <div class="card-body">
                <p id="charactersPlayingAs" class="mb-2">Playing as: <strong>All characters</strong></p>
                <p id="opponentsPlayingAgainst" class="mb-2">Playing against: <strong>All opponents</strong></p>
                <p id="charactersPlayingAgainst" class="mb-2">Opposing characters: <strong>All characters</strong></p>
                <p class="text-muted small">Showing data from <span id="totalGamesCount">0</span> matches</p>
            </div>
        </div>
    </div>
</div>

<!-- Stats Tables Row -->
<div class="row table-section">
    <!-- Character Stats -->
    <div class="col-md-4 mb-4">
        <div class="card stat-card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Character Stats</h5>
                <span class="badge rounded-pill bg-primary" id="character-count">0</span>
            </div>
            <div class="card-body p-0">
                <div class="scrollable-table">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Character</th>
                                <th>Games</th>
                                <th>Win %</th>
                            </tr>
                        </thead>
                        <tbody id="character-stats-table">
                            <!-- Will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Opponent Stats -->
    <div class="col-md-4 mb-4">
        <div class="card stat-card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Opponent Stats</h5>
                <span class="badge rounded-pill bg-primary" id="opponent-count">0</span>
            </div>
            <div class="card-body p-0">
                <div class="scrollable-table">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Opponent</th>
                                <th>Games</th>
                                <th>Win %</th>
                            </tr>
                        </thead>
                        <tbody id="opponent-stats-table">
                            <!-- Will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Opponent Character Stats -->
    <div class="col-md-4 mb-4">
        <div class="card stat-card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Matchup Stats</h5>
                <span class="badge rounded-pill bg-primary" id="matchup-count">0</span>
            </div>
            <div class="card-body p-0">
                <div class="scrollable-table">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Character</th>
                                <th>Games</th>
                                <th>Win %</th>
                            </tr>
                        </thead>
                        <tbody id="matchup-stats-table">
                            <!-- Will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Time Chart -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card stat-card">
            <div class="card-header">
                <h5>Win Rate Over Time</h5>
            </div>
            <div class="card-body">
                <div class="chart-container" style="position: relative; height:300px;">
                    <canvas id="timeChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Character Chart -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card stat-card">
            <div class="card-header">
                <h5>Character Performance</h5>
            </div>
            <div class="card-body">
                <div class="chart-container" style="position: relative; height:300px;">
                    <canvas id="characterChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div id="loadingOverlay" class="loading-overlay">
    <div class="spinner-border loading-spinner" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/pages/player_detailed.js') }}"></script>
{% endblock %}